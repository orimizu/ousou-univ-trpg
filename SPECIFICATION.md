# 桜創大学テーブルトーク 詳細設計書

## 1. プロジェクト概要

桜創大学テーブルトーク（Ousou University Tabletop RPG）は、AI言語モデル（LLM）をゲームマスターとして使用する、日本の大学生活を舞台にしたテーブルトークRPGアプリケーションです。プレイヤーは新入生として架空の「桜創大学」での生活を送り、「学業」「友情」「趣味・特技」「恋愛」「将来への展望」の5つのステータスを成長させていきます。

## 2. システムアーキテクチャ

### 2.1 技術スタック

- **バックエンド**: Python 3.8以上 + Flask
- **フロントエンド**: HTML + CSS + JavaScript（クライアントサイドレンダリング）
- **AI/LLM連携**:
  - Ollama API（ローカルLLM）
  - Google Gemini API
  - Anthropic Claude API
- **ユーティリティライブラリ**:
  - marked.js（マークダウンレンダリング）

### 2.2 システム構成図

```
+------------------+        +-------------------+        +---------------+
|                  |        |                   |        |  LLM Services |
|   Web Browser    | <----> |  Flask Server    | <----> |  - Ollama     |
|   (HTML/CSS/JS)  |        |  (Python)        |        |  - Gemini     |
|                  |        |                   |        |  - Claude     |
+------------------+        +-------------------+        +---------------+
```

## 3. コア機能仕様

### 3.1 ゲームロジック

#### 3.1.1 ステータスシステム

- **ステータス種類**: 「学業」「友情」「趣味・特技」「恋愛」「将来への展望」の5種類
- **ステータス値範囲**: 各ステータス1〜15の整数値
- **初期ステータス設定**: 合計12ポイントをプレイヤーが自由に割り振り（最小値1）

#### 3.1.2 ゲーム進行

- **時間進行**: 1ターンが大学生活の1週間に相当
- **学期制**: 1学期15週間、全4学期（2年間）で完結
- **選択の影響**: プレイヤーの選択によってイベント発生し、ステータス変動
- **ステータス更新**: LLMが状況とプレイヤーの選択に基づいて判断
- **選択肢システム**: LLMが状況に応じて選択肢を提示し、プレイヤーはその中から選択可能

### 3.2 LLM連携

#### 3.2.1 プロンプト設計

- ゲームマスターとしての役割と世界観設定を提示
- プレイヤー情報（名前、学部、ステータス値）を含む
- 会話履歴を維持し、一貫性のある物語を提供
- ステータス更新用の特殊タグ形式を指定
  - `<GameMaster></GameMaster>`: ゲームマスターの発言用
  - `<stats></stats>`: ステータス更新用JSON情報
  - `<options></options>`: 選択肢リスト用
  - `<option></option>`: 個別選択肢用

#### 3.2.2 サポートされるLLMモデル

- **ローカルLLM**: Ollama経由の各種モデル（llama3など）
- **Gemini**: 「gemini-2.0-flash」および「gemini-2.0-pro-exp-02-05」
- **Claude**: 「claude-3-7-sonnet-20250219」

#### 3.2.3 APIキー管理

- **環境変数**: サーバーの環境変数でデフォルトのAPIキーを設定可能
- **UI設定**: 環境変数に設定がない場合、UIからAPIキー設定が可能
- **ローカルストレージ**: ブラウザのローカルストレージにAPIキーを保存（セキュアな利用）
- **マスキング表示**: セキュリティのため、APIキーはマスク表示（目アイコンで一時的に表示可能）

### 3.3 テキスト表示・処理

#### 3.3.1 マークダウンレンダリング

- **ライブラリ**: marked.js を使用したクライアントサイドマークダウン変換
- **両方向対応**: プレイヤーとゲームマスター両方のメッセージをマークダウン対応
- **スタイル分け**: 
  - ゲームマスター: 白背景・黒文字ベースのスタイル
  - プレイヤー: ピンク背景・白文字に適したスタイル
- **対応要素**: 見出し、リスト、コードブロック、テーブル、引用、強調など
- **HTML許可**: マークダウン内でのHTMLタグ使用を許可（sanitize: false）

#### 3.3.2 テキスト処理

- **入力クリーニング**: プレイヤー入力の前後の空白削除（trim）
- **末尾トリム処理**: 正規表現による末尾の改行・空白の徹底的な削除
- **改行処理**: 適切な改行を保持するオプション設定（breaks: true）

### 3.4 選択肢システム

- **選択肢提示**: LLMが状況に応じてプレイヤーに複数の選択肢を提示
- **UI表示**: 専用の選択肢コンテナで視覚的に区別された選択肢ボタンを表示
- **選択処理**: 選択肢クリックでプレイヤーメッセージとして送信され、ゲーム進行
- **会話履歴統合**: 選択肢履歴も会話履歴に含めて保存

### 3.5 セーブ/ロード機能

- **セーブデータ形式**: JSON
- **保存内容**: キャラクター情報、ステータス、会話履歴、選択肢履歴、設定情報
- **エクスポート/インポート**: ローカルファイルへの保存と読み込み
- **タイムスタンプ**: ファイル名に日時情報を含めて管理を容易化

### 3.6 ステータス通知システム

- **視覚的通知**: ステータス更新時に右上にポップアップ通知を表示
- **アニメーション**: スライドインとフェードアウトのアニメーション効果
- **情報表示**: 更新された各ステータスの現在値を表示

## 4. モジュール詳細設計

### 4.1 バックエンド (ousou-univ-trpg.py)

#### 4.1.1 メインモジュール構成

- **環境設定**: 環境変数読み込み、APIキー設定
- **Flaskアプリケーション初期化**: ルート設定、静的ファイル提供
- **APIエンドポイント**: ゲーム応答、モデル情報、セーブ/ロード処理
- **LLM連携関数**: 各LLMサービス（Ollama, Gemini, Claude）への接続処理
- **ユーティリティ関数**: プロンプト生成、レスポンス解析

#### 4.1.2 主要APIエンドポイント

| エンドポイント | メソッド | 機能 |
|--------------|---------|------|
| `/` | GET | メインアプリケーションページ表示 |
| `/static/<path>` | GET | 静的ファイル提供 |
| `/api/ollama-models` | GET | 利用可能なOllamaモデル一覧取得 |
| `/api/game-response` | POST | プレイヤーメッセージに対するAI応答取得 |
| `/api/export-game` | POST | ゲーム状態をJSONファイルにエクスポート |
| `/api/import-game` | POST | JSONファイルからゲーム状態をインポート |

#### 4.1.3 LLM連携処理

- **Ollama**: ローカルサーバー上のOllamaモデルと通信
  - `/api/generate`エンドポイントにJSONデータを送信
  - 非ストリーミングモードでレスポンス取得

- **Gemini**: Google Gemini APIとの通信
  - `google.generativeai`ライブラリ使用
  - 指定されたモデル名で生成リクエスト
  - APIキーは環境変数またはUIから受け取ったものを使用

- **Claude**: Anthropic Claude APIとの通信
  - クライアントライブラリまたは直接APIリクエスト
  - エラー発生時のフォールバック対応
  - メッセージベースのAPI形式

#### 4.1.4 ユーティリティ関数

- **create_prompt**: ゲームのプロンプトを生成
  - 基本設定、キャラクター情報、会話履歴を含む
  - LLM用の特殊タグを追加

- **extract_game_master_response**: LLMの応答から情報を抽出
  - `<GameMaster></GameMaster>`から応答テキスト抽出
  - `<stats></stats>`からJSONステータス情報抽出
  - `<options></options>`から選択肢リスト抽出

### 4.2 フロントエンド

#### 4.2.1 HTMLレイアウト (index.html)

- **ゲーム設定画面**: 基本ルール、世界観、NPCリスト表示
- **キャラクター作成画面**: 名前、学部選択、ステータス設定
- **会話画面**: チャットインターフェース、メッセージ表示、入力欄
- **選択肢表示**: 専用の選択肢コンテナと選択肢ボタン
- **モデル選択インターフェース**: LLMモデル切り替えUI
- **APIキー設定インターフェース**: Geminiモデル選択時に表示されるパスワードフィールドと表示切替ボタン
- **セーブ/ロード機能**: ボタンとファイル選択UI
- **マークダウンライブラリ**: marked.js CDNリンク
- **マークダウンスタイル**: ゲームマスターとプレイヤー用のスタイル定義

#### 4.2.2 スタイル設計 (styles.css)

- **レスポンシブデザイン**: モバイル対応レイアウト
- **テーマデザイン**: 桜をモチーフとした配色
  - プライマリカラー: `#e85a71`（桜ピンク）
  - セカンダリカラー: `#4ea1d3`（空色）
- **UIコンポーネント**:
  - メッセージバブル（プレイヤー/GM）
  - ステータス調整コントロール
  - 選択肢ボタン
  - ステータス更新通知
  - APIキー入力フォーム（マスキング機能付き）
- **マークダウンスタイル**:
  - ゲームマスター用（白背景・黒文字ベース）
  - プレイヤー用（ピンク背景・白文字ベース）
  - 各種マークダウン要素（見出し、リスト、コードブロックなど）
- **アニメーション効果**:
  - ステータス通知のスライドイン
  - フェードアウト効果

#### 4.2.3 スクリプト機能 (script.js)

- **ゲーム状態管理**: キャラクター情報、ステータス、会話履歴保持
- **UI制御**: 画面切り替え、ボタン状態管理、メッセージ表示
- **ステータス操作**: 値増減、上限チェック、残りポイント計算
- **選択肢管理**: 選択肢表示、クリックイベント処理、会話履歴への統合
- **API通信**: サーバーとの非同期通信処理
- **セーブ/ロード処理**: ゲームデータのJSON操作、タイムスタンプ付きファイル名生成
- **モデル選択**: LLMモデル切り替え、Ollamaモデル一覧取得
- **APIキー管理**: 入力、保存、復元、表示切替機能
- **マークダウン処理**:
  - プレイヤーとゲームマスター両方のメッセージをマークダウン変換
  - marked.jsを使用したHTMLへの変換処理
  - メッセージ表示時の適切なスタイル適用
- **テキスト処理**:
  - プレイヤー入力のトリム処理
  - 末尾の余分な改行・空白の正規表現による削除
- **ステータス通知**:
  - 更新通知の生成と表示
  - タイマーによる自動消去

## 5. データモデル

### 5.1 ゲーム状態オブジェクト

```javascript
gameState = {
    characterName: string,       // プレイヤーキャラクター名
    department: string,          // 所属学部
    stats: {                     // ステータス値
        academics: number,       // 学業 (1-15)
        friendship: number,      // 友情 (1-15)
        hobbies: number,         // 趣味・特技 (1-15)
        romance: number,         // 恋愛 (1-15)
        future: number           // 将来への展望 (1-15)
    },
    remainingPoints: number,     // ステータス割り振り残ポイント
    conversation: [              // 会話履歴
        {
            speaker: string,     // "player" または "gamemaster"
            text: string,        // メッセージ内容
            options: array       // 選択肢配列（gamemasterの場合のみ）
        }
    ],
    loading: boolean,            // 読み込み中フラグ
    modelType: string,           // 使用中のLLMタイプ
    ollamaModel: string,         // 選択されたOllamaモデル名
    googleApiKey: string         // Gemini API Key
}
```

### 5.2 APIリクエスト/レスポンス形式

#### 5.2.1 ゲーム応答リクエスト（/api/game-response）

```javascript
{
    playerName: string,          // プレイヤー名
    department: string,          // 所属学部
    stats: {                     // 現在のステータス
        academics: number,
        friendship: number,
        hobbies: number,
        romance: number,
        future: number
    },
    playerMessage: string,       // プレイヤーからの最新メッセージ
    conversation: array,         // 会話履歴配列
    modelType: string,           // 使用するLLMタイプ
    ollamaModel: string,         // 選択されたOllamaモデル名（ローカルLLM使用時）
    googleApiKey: string         // Gemini APIキー（オプション、Geminiモデル使用時）
}
```

#### 5.2.2 ゲーム応答レスポンス

```javascript
{
    gameMasterResponse: string,  // ゲームマスターの応答テキスト
    statsUpdate: {               // 更新されたステータス（null = 更新なし）
        academics: number,
        friendship: number,
        hobbies: number,
        romance: number,
        future: number
    },
    options: array               // 提示する選択肢の配列（空の場合は選択肢なし）
}
```

#### 5.2.3 Ollamaモデル一覧リクエスト（/api/ollama-models）

```javascript
// GETリクエスト、パラメータなし
```

#### 5.2.4 Ollamaモデル一覧レスポンス

```javascript
{
    models: array                // 利用可能なOllamaモデル名の配列
}
```

#### 5.2.5 セーブデータ形式

```javascript
{
    characterName: string,       // プレイヤー名
    department: string,          // 所属学部
    stats: object,               // ステータス値
    conversation: array,         // 会話履歴（選択肢情報を含む）
    modelType: string,           // 使用中のLLMタイプ
    ollamaModel: string          // 選択されたOllamaモデル名
}
```

## 6. 拡張性と今後の展望

### 6.1 拡張可能な機能

- **追加LLMサポート**: 新たなLLMサービスの追加
- **マルチプレイヤー**: 複数プレイヤーによる共同プレイ
- **イベントシステム**: 事前定義されたイベントとランダムイベント
- **UIテーマカスタマイズ**: 季節や状況に合わせた背景変更
- **複数APIキー管理**: 他のLLMサービス向けにも同様のAPIキー管理機能を拡張
- **高度なマークダウン機能**: 数式、図表、タイムライン表示などの拡張マークダウン
- **分岐選択肢システム**: より複雑な選択肢パスと結果追跡

### 6.2 潜在的な改善点

- **ストリーミングレスポンス**: リアルタイムでの応答表示機能
- **キャラクター画像生成**: AIによるキャラクターアバター生成
- **音声インターフェース**: 音声入力と音声出力サポート
- **データ分析ダッシュボード**: プレイ統計、選択傾向の可視化
- **強化されたセキュリティ**: APIキー管理のセキュリティ向上
- **マークダウンエディタ**: リッチテキスト入力支援機能
- **選択肢のカスタマイズ**: ユーザー定義の選択肢や修正機能

## 7. 開発・運用関連

### 7.1 必要依存パッケージ

#### 7.1.1 サーバーサイド
- Flask==2.3.3
- python-dotenv==1.0.0
- requests==2.31.0
- google-generativeai==0.3.1
- anthropic==0.5.0

#### 7.1.2 クライアントサイド
- marked.js (CDN: https://cdn.jsdelivr.net/npm/marked/marked.min.js)

### 7.2 環境変数設定

- `OLLAMA_BASE_URL`: Ollama APIのベースURL
- `OLLAMA_MODEL`: デフォルトのOllamaモデル名
- `GOOGLE_API_KEY`: Google Gemini APIキー（省略可、UIから設定可能）
- `ANTHROPIC_API_KEY`: Anthropic Claude APIキー

### 7.3 デプロイメント

- ローカル開発環境: Python仮想環境 + Ollama
- 本番環境オプション: クラウドサーバー + 外部LLM API

## 8. ゲームコンテンツ設計

### 8.1 世界観設定

- **舞台**: 東京都内の「桜創大学」（架空）
- **時期**: 4月初旬（新学期開始、桜満開）
- **環境**: 大学キャンパス、学生寮、周辺施設

### 8.2 NPCキャラクター

| 名前 | 役割 | 特徴 |
|------|------|------|
| 佐藤健太 | 先輩寮生 | 大学情報に詳しい、頼りになる |
| 田中美咲 | 同学部学生 | 明るい性格、交友関係が広い |
| 山本教授 | 学部教授 | 厳格だが学生想い、キャリア相談可能 |
| 鈴木浩二 | サークル先輩 | 情熱的、サークル活動熱心 |
| 中村さくら | 別学部学生 | 物静か、特定分野に詳しい |

### 8.3 プレイヤーキャラクター設定

- **年齢**: 18歳（大学1年生）
- **出身**: 地方から上京してきたばかり
- **住居**: 大学の学生寮
- **学部選択肢**: 文学部、経済学部、理工学部、医学部、芸術学部

## 9. ライセンスと著作権情報

- **ライセンス**: MIT License
- **著作権**: Copyright (c) 2025 orimizu
- **作者情報**:
  - 名前: りゅうり/織水流離(Ryuuri Orimizu)
  - Twitter(X): @ryuuri_tweet
  - YouTube: https://www.youtube.com/@ryuuri
  - GitHub: https://github.com/orimizu
